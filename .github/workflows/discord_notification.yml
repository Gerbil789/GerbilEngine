name: Discord Notification

on:
  workflow_call:
    inputs:
      status:
        description: 'Job status'
        required: true
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: string
      repository:
        description: 'Repository name'
        required: true
        type: string
      sha:
        description: 'Commit SHA'
        required: true
        type: string
    secrets:
      DISCORD_WEBHOOK_URL:
        required: true

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        run: |
          $STATUS = "${{ inputs.status }}"
          $BRANCH = "${{ inputs.branch }}"
          $SHA = "${{ inputs.sha }}"
          $REPOSITORY = "${{ inputs.repository }}"
          $URL = "https://github.com/$REPOSITORY/commit/$SHA"
          $payload = @{
            username = "Git Watcher"
            embeds = @(
              @{
                title = "Build Project Workflow Status"
                description = "The build project workflow has completed."
                color = if ($STATUS -eq 'success') { 3066993 } else { 15158332 }
                fields = @(
                  @{
                    name = "Repository"
                    value = "$REPOSITORY"
                  },
                  @{
                    name = "Branch"
                    value = "$BRANCH"
                  },
                  @{
                    name = "Commit"
                    value = "[$SHA]($URL)"
                  },
                  @{
                    name = "Status"
                    value = "$STATUS"
                  }
                )
              }
            )
          }

          $jsonPayload = $payload | ConvertTo-Json -Depth 4
          Invoke-RestMethod -Uri ${{ secrets.DISCORD_WEBHOOK_URL }} -Method Post -ContentType "application/json" -Body $jsonPayload